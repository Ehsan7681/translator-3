<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مترجم زیرنویس با هوش مصنوعی</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #475569;
            --accent-color: #0ea5e9;
            --background-color: #f1f5f9;
            --surface-color: #ffffff;
            --error-color: #ef4444;
            --success-color: #10b981;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --disabled-color: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
            --transition: all 0.2s ease-in-out;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            margin: 0;
            padding: 16px;
            line-height: 1.5;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 24px; background-color: var(--surface-color); border-radius: var(--radius); box-shadow: var(--shadow); }
        h1 { margin: 0 0 24px; color: var(--primary-color); font-size: 1.75rem; font-weight: 700; }
        .card { background: var(--surface-color); border-radius: var(--radius); box-shadow: var(--shadow-sm); padding: 16px; margin-bottom: 24px; border: 1px solid var(--border-color); }
        .card-title { margin: 0 0 16px; font-size: 1.25rem; font-weight: 600; color: var(--primary-color); }
        .form-group { margin-bottom: 16px; }
        .form-row { display: flex; flex-wrap: wrap; gap: 16px; }
        .form-row > * { flex: 1; min-width: 250px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; }
        input, select, textarea { width: 100%; padding: 8px 12px; font-size: 1rem; border: 1px solid var(--border-color); border-radius: var(--radius); box-sizing: border-box; }
        button { padding: 8px 16px; font-size: 1rem; font-weight: 500; border-radius: var(--radius); background-color: var(--primary-color); color: white; border: none; cursor: pointer; }
        button:disabled { background-color: var(--disabled-color); cursor: not-allowed; }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-outline { background: transparent; color: var(--primary-color); border: 1px solid var(--primary-color); }
        .btn-sm { padding: 4px 8px; font-size: 0.875rem; }
        .dropzone { border: 2px dashed var(--border-color); padding: 24px; text-align: center; cursor: pointer; }
        .dropzone.drag-over { border-color: var(--primary-color); background-color: rgba(37, 99, 235, 0.1); }
        .progress-container { margin: 16px 0; }
        .progress-bar-container { width: 100%; height: 12px; background-color: var(--border-color); border-radius: 99px; }
        .progress-bar { height: 100%; background-color: var(--primary-color); border-radius: 99px; transition: width 0.2s ease; }
        .hidden { display: none; }
        .api-keys-container { display: flex; flex-direction: column; gap: 8px; }
        .api-key-item { display: flex; gap: 8px; align-items: center; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #fff; border-top: 4px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { color: white; margin-top: 16px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 16px; }
        .tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom: 2px solid var(--primary-color); color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .subtitle-item { padding: 12px; border-bottom: 1px solid var(--border-color); }
        .subtitle-item.error { background-color: rgba(239, 68, 68, 0.1); }
        .alert { padding: 12px; border-radius: var(--radius); margin-top: 8px; }
        .alert-info { background-color: rgba(37, 99, 235, 0.1); border: 1px solid var(--primary-color); }
    </style>
</head>
<body>
    <div class="container">
        <h1>مترجم زیرنویس با هوش مصنوعی</h1>

        <div class="card">
            <h2 class="card-title">تنظیمات API</h2>
            <div class="form-group">
                <label>کلیدهای API گوگل Gemini:</label>
                <div id="apiKeysContainer" class="api-keys-container"></div>
                <button id="addApiKeyBtn" class="btn-sm">+ افزودن کلید API</button>
                <p class="text-secondary" style="font-size: 0.875rem; margin-top: 4px;">
                    کلید API را از <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a> دریافت کنید.
                </p>
            </div>
            <div class="form-group">
                <label for="rotationDelayInput">تاخیر بین چرخش API (میلی‌ثانیه):</label>
                <input type="number" id="rotationDelayInput" value="2000" min="500" step="500">
            </div>
            <div class="form-group">
                <label for="batchSize">اندازه دسته ترجمه:</label>
                <input type="number" id="batchSize" value="5" min="1" max="20">
                <p class="text-secondary" style="font-size: 0.875rem;">تعداد زیرنویس‌ها در هر درخواست (بیشتر = سریع‌تر)</p>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">تنظیمات ترجمه</h2>
            <div class="form-row">
                <div class="form-group">
                    <label for="targetLanguageSelect">زبان مقصد:</label>
                    <select id="targetLanguageSelect">
                        <option value="fa" selected>فارسی</option>
                        <option value="en">انگلیسی</option>
                        <option value="ar">عربی</option>
                        <option value="fr">فرانسوی</option>
                        <option value="de">آلمانی</option>
                        <option value="es">اسپانیایی</option>
                        <option value="ru">روسی</option>
                        <option value="zh">چینی</option>
                        <option value="ja">ژاپنی</option>
                        <option value="ko">کره‌ای</option>
                        <option value="tr">ترکی</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="translationStyleSelect">سبک ترجمه:</label>
                    <select id="translationStyleSelect">
                        <option value="conversational" selected>محاوره‌ای/گفتاری</option>
                        <option value="formal">رسمی</option>
                        <option value="simple">ساده و روان</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="customPromptText">راهنمایی سفارشی برای ترجمه:</label>
                <textarea id="customPromptText" rows="3" placeholder="راهنمایی خاص برای ترجمه (اختیاری)"></textarea>
            </div>
        </div>

        <div class="card">
            <h2 class="card-title">آپلود فایل زیرنویس</h2>
            <div id="dropzone" class="dropzone">
                <p>فایل SRT را اینجا بکشید یا کلیک کنید</p>
                <input type="file" id="fileInput" accept=".srt" style="display: none;">
            </div>
            <div id="fileInfo" class="alert alert-info hidden">
                <span id="fileName"></span><br>
                <span id="subtitleCount"></span>
            </div>
            <div class="form-group">
                <button id="translateBtn" disabled>شروع ترجمه</button>
                <button id="pauseBtn" class="btn-secondary" disabled>توقف</button>
                <button id="resumeBtn" class="btn-outline" disabled>ادامه</button>
                <button id="clearBtn" class="btn-secondary" disabled>پاک کردن</button>
            </div>
        </div>

        <div id="currentTranslation" class="card hidden">
            <h2 class="card-title">زیرنویس در حال ترجمه</h2>
            <div class="form-row">
                <div class="form-group">
                    <label>متن اصلی:</label>
                    <textarea id="currentOriginal" readonly rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>متن ترجمه‌شده:</label>
                    <textarea id="currentTranslated" readonly rows="3"></textarea>
                </div>
            </div>
        </div>

        <div id="progressContainer" class="progress-container hidden">
            <h3 class="section-title">پیشرفت ترجمه</h3>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span id="progressStats"></span>
                <span id="progressText">0%</span>
            </div>
            <p id="currentSubtitleInfo" class="text-secondary"></p>
        </div>

        <div id="resultsContainer" class="hidden">
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="translated">زیرنویس‌های ترجمه‌شده</div>
                    <div class="tab" data-tab="original">زیرنویس‌های اصلی</div>
                    <div class="tab" data-tab="compare">مقایسه</div>
                </div>
                <div id="translatedSubtitles" class="tab-content active"></div>
                <div id="originalSubtitles" class="tab-content"></div>
                <div id="compareSubtitles" class="tab-content"></div>
            </div>
            <div class="mt-4" style="margin-top: 16px;">
                <button id="downloadBtn" class="btn-success" style="background-color: var(--success-color);">دانلود</button>
                <button id="newTranslationBtn" class="btn-outline">ترجمه جدید</button>
            </div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <p class="loading-text">در حال ترجمه...</p>
    </div>

    <script>
        let originalSubtitles = [];
        let translatedSubtitles = [];
        let currentFileName = '';
        let translationInProgress = false;
        let paused = false;
        let currentApiKeyIndex = 0;
        let apiKeys = [];

        const fileInput = document.getElementById('fileInput');
        const dropzone = document.getElementById('dropzone');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const subtitleCount = document.getElementById('subtitleCount');
        const translateBtn = document.getElementById('translateBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resumeBtn = document.getElementById('resumeBtn');
        const clearBtn = document.getElementById('clearBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressStats = document.getElementById('progressStats');
        const currentSubtitleInfo = document.getElementById('currentSubtitleInfo');
        const resultsContainer = document.getElementById('resultsContainer');
        const translatedSubtitlesDiv = document.getElementById('translatedSubtitles');
        const originalSubtitlesDiv = document.getElementById('originalSubtitles');
        const compareSubtitles = document.getElementById('compareSubtitles');
        const downloadBtn = document.getElementById('downloadBtn');
        const newTranslationBtn = document.getElementById('newTranslationBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const targetLanguageSelect = document.getElementById('targetLanguageSelect');
        const translationStyleSelect = document.getElementById('translationStyleSelect');
        const customPromptText = document.getElementById('customPromptText');
        const rotationDelayInput = document.getElementById('rotationDelayInput');
        const batchSizeInput = document.getElementById('batchSize');
        const currentTranslation = document.getElementById('currentTranslation');
        const currentOriginal = document.getElementById('currentOriginal');
        const currentTranslated = document.getElementById('currentTranslated');

        // بارگذاری کلیدهای API از localStorage
        document.addEventListener('DOMContentLoaded', () => {
            const savedApiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [];
            if (savedApiKeys.length > 0) {
                apiKeysContainer.innerHTML = '';
                savedApiKeys.forEach(key => addApiKeyField(key));
            } else {
                addApiKeyField();
            }
        });

        function addApiKeyField(value = '') {
            const apiKeyItem = document.createElement('div');
            apiKeyItem.className = 'api-key-item';
            apiKeyItem.innerHTML = `
                <input type="text" class="api-key-input" value="${value}" placeholder="کلید API گوگل Gemini را وارد کنید">
                <button class="btn-sm btn-outline remove-api-key">حذف</button>
            `;
            apiKeysContainer.appendChild(apiKeyItem);
            apiKeyItem.querySelector('.remove-api-key').addEventListener('click', () => {
                if (apiKeysContainer.children.length > 1) {
                    apiKeyItem.remove();
                    collectApiKeys();
                } else {
                    alert('حداقل یک کلید API باید وجود داشته باشد.');
                }
            });
            apiKeyItem.querySelector('.api-key-input').addEventListener('input', collectApiKeys);
            collectApiKeys();
        }

        document.getElementById('addApiKeyBtn').addEventListener('click', () => addApiKeyField());

        function collectApiKeys() {
            apiKeys = [];
            document.querySelectorAll('.api-key-input').forEach(input => {
                const key = input.value.trim();
                if (key) apiKeys.push(key);
            });
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
            return apiKeys.length > 0;
        }

        function getNextApiKey() {
            if (apiKeys.length === 0) throw new Error('هیچ کلید API معتبری وجود ندارد.');
            currentApiKeyIndex = (currentApiKeyIndex + 1) % apiKeys.length;
            return apiKeys[currentApiKeyIndex];
        }

        function getCurrentApiKey() {
            if (apiKeys.length === 0) throw new Error('هیچ کلید API معتبری وجود ندارد.');
            return apiKeys[currentApiKeyIndex];
        }

        // مدیریت آپلود فایل
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('drag-over'));

        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        dropzone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file || file.name.split('.').pop().toLowerCase() !== 'srt') {
                alert('لطفاً یک فایل SRT معتبر انتخاب کنید.');
                return;
            }
            currentFileName = file.name;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    originalSubtitles = parseSRT(e.target.result);
                    fileName.textContent = `فایل: ${file.name}`;
                    subtitleCount.textContent = `تعداد زیرنویس‌ها: ${originalSubtitles.length}`;
                    fileInfo.classList.remove('hidden');
                    translateBtn.disabled = false;
                    clearBtn.disabled = false;
                } catch (error) {
                    alert(`خطا در پردازش فایل: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }

        function parseSRT(content) {
            const subtitles = [];
            const blocks = content.trim().split(/\n\s*\n/);
            blocks.forEach((block, index) => {
                const lines = block.trim().split('\n');
                if (lines.length < 3) return;
                const id = parseInt(lines[0]) || index + 1;
                const timeMatch = lines[1].match(/(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})/);
                if (!timeMatch) return;
                subtitles.push({
                    id,
                    startTime: timeMatch[1],
                    endTime: timeMatch[2],
                    text: lines.slice(2).join('\n').trim()
                });
            });
            return subtitles;
        }

        // پاک کردن
        clearBtn.addEventListener('click', () => {
            if (translationInProgress) return alert('لطفاً صبر کنید تا ترجمه تمام شود.');
            originalSubtitles = [];
            translatedSubtitles = [];
            currentFileName = '';
            fileInput.value = '';
            fileInfo.classList.add('hidden');
            progressContainer.classList.add('hidden');
            resultsContainer.classList.add('hidden');
            currentTranslation.classList.add('hidden');
            translateBtn.disabled = true;
            pauseBtn.disabled = true;
            resumeBtn.disabled = true;
            clearBtn.disabled = true;
            localStorage.removeItem('translationProgress');
            localStorage.removeItem('translatedSubtitles');
        });

        // مدیریت تب‌ها
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(`${tab.getAttribute('data-tab')}Subtitles`).classList.add('active');
            });
        });

        // شروع ترجمه
        translateBtn.addEventListener('click', async () => {
            if (translationInProgress) return alert('ترجمه در حال انجام است.');
            if (!collectApiKeys()) return alert('لطفاً حداقل یک کلید API معتبر وارد کنید.');
            if (originalSubtitles.length === 0) return alert('لطفاً یک فایل زیرنویس انتخاب کنید.');
            translationInProgress = true;
            paused = false;
            pauseBtn.disabled = false;
            resumeBtn.disabled = true;
            translateBtn.disabled = true;
            await translateSubtitles();
        });

        // توقف و ادامه
        pauseBtn.addEventListener('click', () => {
            paused = true;
            pauseBtn.disabled = true;
            resumeBtn.disabled = false;
            currentSubtitleInfo.textContent = 'ترجمه متوقف شد.';
        });

        resumeBtn.addEventListener('click', async () => {
            paused = false;
            pauseBtn.disabled = false;
            resumeBtn.disabled = true;
            currentSubtitleInfo.textContent = 'در حال ادامه ترجمه...';
            await translateSubtitles();
        });

        // تابع ترجمه
        async function translateSubtitles() {
            let startIndex = parseInt(localStorage.getItem('translationProgress')) || 0;
            translatedSubtitles = JSON.parse(localStorage.getItem('translatedSubtitles')) || [];
            const batchSize = parseInt(batchSizeInput.value) || 5;
            progressContainer.classList.remove('hidden');
            currentTranslation.classList.remove('hidden');
            updateProgress(startIndex, originalSubtitles.length);

            try {
                for (let i = startIndex; i < originalSubtitles.length; i += batchSize) {
                    if (paused) {
                        localStorage.setItem('translationProgress', i);
                        localStorage.setItem('translatedSubtitles', JSON.stringify(translatedSubtitles));
                        translationInProgress = false;
                        return;
                    }

                    const batch = originalSubtitles.slice(i, Math.min(i + batchSize, originalSubtitles.length));
                    const batchPromises = batch.map(async (subtitle, idx) => {
                        currentOriginal.value = subtitle.text;
                        currentTranslated.value = 'در حال ترجمه...';
                        currentSubtitleInfo.textContent = `در حال ترجمه زیرنویس ${i + idx + 1} از ${originalSubtitles.length}`;

                        let retryCount = 0;
                        const maxRetries = 3;
                        while (retryCount < maxRetries) {
                            try {
                                const translatedText = await translateWithGemini(
                                    subtitle.text,
                                    subtitle.text,
                                    targetLanguageSelect.value,
                                    false,
                                    getCurrentApiKey(),
                                    'gemini-1.5-pro'
                                );
                                currentTranslated.value = translatedText;
                                return { ...subtitle, text: translatedText };
                            } catch (error) {
                                retryCount++;
                                if (error.message.includes('rate limit') || error.message.includes('quota')) {
                                    const delay = parseInt(rotationDelayInput.value) || 2000;
                                    await new Promise(resolve => setTimeout(resolve, delay));
                                    getNextApiKey();
                                } else if (retryCount >= maxRetries) {
                                    currentTranslated.value = subtitle.text;
                                    return { ...subtitle, text: subtitle.text, error: true, errorMessage: 'خطا پس از چندین تلاش' };
                                } else {
                                    await new Promise(resolve => setTimeout(resolve, 1000));
                                }
                            }
                        }
                    });

                    const batchResults = await Promise.all(batchPromises);
                    translatedSubtitles.push(...batchResults);
                    localStorage.setItem('translationProgress', i + batchSize);
                    localStorage.setItem('translatedSubtitles', JSON.stringify(translatedSubtitles));
                    updateProgress(translatedSubtitles.length, originalSubtitles.length);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                translationInProgress = false;
                currentSubtitleInfo.textContent = 'ترجمه با موفقیت به پایان رسید.';
                displayResults();
                alert('ترجمه با موفقیت به پایان رسید!');
            } catch (error) {
                currentSubtitleInfo.textContent = `خطا در ترجمه: ${error.message}`;
                alert(`خطا در ترجمه: ${error.message}`);
            } finally {
                if (!paused) {
                    pauseBtn.disabled = true;
                    resumeBtn.disabled = true;
                    translateBtn.disabled = false;
                    currentTranslation.classList.add('hidden');
                    localStorage.removeItem('translationProgress');
                    localStorage.removeItem('translatedSubtitles');
                }
            }
        }

        // تابع ترجمه با Gemini
        async function translateWithGemini(contextText, originalText, targetLanguage, preserveTags, apiKey, model) {
            loadingOverlay.style.display = 'flex';
            try {
                const isPersian = originalText.match(/^[\u0600-\u06FF\s،؛:!؟.\-]+$/);
                if (targetLanguage === 'fa' && isPersian) {
                    return originalText;
                }

                let prompt = `Translate the following text to ${getLanguageName(targetLanguage)} in a ${translationStyleSelect.value} style. `;
                if (preserveTags) prompt += "Preserve all HTML tags and formatting exactly as they appear. ";
                const customPrompt = customPromptText.value.trim();
                if (customPrompt) prompt += `${customPrompt} `;
                prompt += "Return ONLY the translated text without any additional content or explanations.";

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }, { text: originalText }] }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    if (errorData.error?.message.includes('rate limit') || errorData.error?.message.includes('quota')) {
                        throw new Error('محدودیت تعداد درخواست‌ها');
                    }
                    throw new Error(`خطا در API: ${response.status} - ${errorData.error?.message || 'مشکل ناشناخته'}`);
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content.parts[0]) {
                    const translatedText = data.candidates[0].content.parts[0].text.trim();
                    return translatedText !== originalText ? translatedText : originalText;
                }
                throw new Error('پاسخ نامعتبر از API');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // بروزرسانی پیشرفت
        function updateProgress(completed, total) {
            const percentage = Math.floor((completed / total) * 100);
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `${percentage}%`;
            progressStats.textContent = `${completed}/${total} زیرنویس`;
        }

        // نمایش نتایج
        function displayResults() {
            let translatedHtml = translatedSubtitles.map(subtitle => `
                <div class="subtitle-item ${subtitle.error ? 'error' : ''}">
                    <div>${subtitle.id}</div>
                    <div>${subtitle.startTime} --> ${subtitle.endTime}</div>
                    <div>${subtitle.text}</div>
                    ${subtitle.error ? `<div style="color: var(--error-color);">خطا: ${subtitle.errorMessage}</div>` : ''}
                </div>
            `).join('');
            translatedSubtitlesDiv.innerHTML = translatedHtml || '<p>هیچ زیرنویسی موجود نیست</p>';

            let originalHtml = originalSubtitles.map(subtitle => `
                <div class="subtitle-item">
                    <div>${subtitle.id}</div>
                    <div>${subtitle.startTime} --> ${subtitle.endTime}</div>
                    <div>${subtitle.text}</div>
                </div>
            `).join('');
            originalSubtitlesDiv.innerHTML = originalHtml || '<p>هیچ زیرنویسی موجود نیست</p>';

            let compareHtml = originalSubtitles.map((original, i) => `
                <div class="subtitle-item ${translatedSubtitles[i]?.error ? 'error' : ''}">
                    <div>${original.id}</div>
                    <div>${original.startTime} --> ${original.endTime}</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>متن اصلی: ${original.text}</div>
                        <div>ترجمه: ${translatedSubtitles[i]?.text || 'ترجمه نشده'}</div>
                    </div>
                    ${translatedSubtitles[i]?.error ? `<div style="color: var(--error-color);">خطا: ${translatedSubtitles[i].errorMessage}</div>` : ''}
                </div>
            `).join('');
            compareSubtitles.innerHTML = compareHtml || '<p>هیچ زیرنویسی موجود نیست</p>';

            resultsContainer.classList.remove('hidden');
        }

        // دانلود فایل
        downloadBtn.addEventListener('click', () => {
            if (!translatedSubtitles.length) return alert('هیچ زیرنویس ترجمه‌شده‌ای وجود ندارد.');
            const srtContent = translatedSubtitles.map(s => `${s.id}\n${s.startTime} --> ${s.endTime}\n${s.text}\n\n`).join('');
            const blob = new Blob([srtContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentFileName.split('.')[0]}_${targetLanguageSelect.value}.srt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // ترجمه جدید
        newTranslationBtn.addEventListener('click', () => clearBtn.click());

        // تابع کمکی برای نام زبان
        function getLanguageName(langCode) {
            const languages = {
                'fa': 'Persian', 'en': 'English', 'ar': 'Arabic', 'fr': 'French',
                'de': 'German', 'es': 'Spanish', 'ru': 'Russian', 'zh': 'Chinese',
                'ja': 'Japanese', 'ko': 'Korean', 'tr': 'Turkish'
            };
            return languages[langCode] || langCode;
        }
    </script>
</body>
</html>
